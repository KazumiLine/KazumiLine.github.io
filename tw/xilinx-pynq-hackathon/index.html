<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-30S6V0G7D2"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'G-30S6V0G7D2');
    </script>
  

  <!-- Baidu Tongji -->
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="想將平時的一些作品與專案放在這裡，作為一個紀錄"/>
  <meta name="keyword" content=""/>
  <link rel="shortcut icon" href="/img/avatar/roguerabbit.jpg"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css"/>
    <link rel="stylesheet" href="/css/widget.css"/>
    <link rel="stylesheet" href="/css/rocket.css"/>
    <link rel="stylesheet" href="/css/signature.css"/>
    <link rel="stylesheet" href="/css/catalog.css"/>
    <link rel="stylesheet" href="/css/livemylife.css"/>

    
      <!-- wave start -->
      <link rel="stylesheet" href="/css/wave.css"/>
      <!-- wave end -->
    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="https://kazumiline.github.io/tw/xilinx-pynq-hackathon/">
  <title>
    
      xilinx-pynq-hackathon - kazumi&#39;s personal website
    
  </title>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<!-- hexo injector head_end end --><style type="text/css">
.spoiler {
  display: inline-flex;
}
p.spoiler {
  display: flex;
}
.spoiler a {
  pointer-events: none;
}
.spoiler-blur, .spoiler-blur > * {
  transition: text-shadow .5s ease;
}
.spoiler .spoiler-blur, .spoiler .spoiler-blur > * {
  color: rgba(0, 0, 0, 0);
  background-color: rgba(0, 0, 0, 0);
  text-shadow: 0 0 10px grey;
  cursor: pointer;
}
.spoiler .spoiler-blur:hover, .spoiler .spoiler-blur:hover > * {
  text-shadow: 0 0 5px grey;
}
.spoiler-box, .spoiler-box > * {
  transition: color .5s ease,
  background-color .5s ease;
}
.spoiler .spoiler-box, .spoiler .spoiler-box > * {
  color: black;
  background-color: black;
  text-shadow: none;
}</style><meta name="generator" content="Hexo 5.4.0"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--dark">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'dark';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Kazumi&#39;s Website</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">首頁</a>
          </li>

          
          
          
          
          <li>
            <a href="/about/">
              
              關於
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/archive/">
              
              歸檔
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/categories/">
              
              分類
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/tags/">
              
              標簽
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>搜索</a>
          </li>
          

          <!-- LangSelect -->
          
          
          
          
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: url('/img/header_img/lml_bg.jpg');
      --intro-header-background-image-url-page: url('//img/header_img/lml_bg.jpg');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/lml_bg.jpg');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('//img/header_img/lml_bg.jpg');
    }

    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('/img/header_img/lml_bg.jpg'); */
      
    }

    
      #signature {/*signature*/
        background-image: url('/img/signature/signature2.png');
      }
    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#Hackathon" title="Hackathon">Hackathon</a>
              
              <a class="tag" href="/tags/#Python" title="Python">Python</a>
              
              <a class="tag" href="/tags/#OpenCV" title="OpenCV">OpenCV</a>
              
              <a class="tag" href="/tags/#FPGA" title="FPGA">FPGA</a>
              
            </div>
            <h1>xilinx-pynq-hackathon</h1>
            <h2 class="subheading">比賽滿好玩的w</h2>
            <span class="meta">
              Posted by KazumiLin on
              2021-09-30
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">8</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">2.3k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- WordCount end -->
            
            
            <!-- 不蒜子统计 start -->
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- 不蒜子统计 end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<script src='https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js'></script>
<script>
  if (window.mermaid) {
    mermaid.initialize({theme: 'forest'});
  }
</script>

<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <h1>FPGA Object Detection&amp;Tracking</h1>
<pre class="mermaid">graph TD;
    A[物件辨識] --> B[物件追蹤];
    B[物件追蹤] --> C[變換車道檢測];
    C[變換車道檢測] --> F[蛇行違規檢測];
    B[物件追蹤] --> D[車流量檢測];
    A[物件辨識] --> E[異常物件檢測];</pre>
<h2 id="簡介">簡介</h2>
<p>隨著AI時代的到來，我們希望可以透過設計於路側設備端的影像擷取與即時運算，掌握即時混合車流，再進行交通系統智慧化。<br>
透過設計輕量化的演算法在FPGA版上的即時運算，可以快速地同步訊息至管理端，實現移動交通之事件通報、風險預測、盲點警示、事件預警等AI智慧應用</p>
<h2 id="Solution">Solution</h2>
<h3 id="演算法">演算法</h3>
<p>我們先將流程簡化成如下，以便後續的說明</p>
<pre class="mermaid">graph LR;
    A1[Frame] -->A2[Foreground Detection];
    A3[Collect Data] --> A4[Training Model];
    A4[Training Model] --> A5[Application];
    A2 --> B1[Object Detection];
    B1[Object Detection] --> B2[Object Tracking];
    B2[Object Tracking]--> A3;
    A2 --> C1[Road Marking Detection];
    C1 --> A3;</pre>
<h4 id="Foreground-Detection">Foreground Detection</h4>
<p>我們使用了基於KNN以及高斯混合模型的Foreground Detection演算法，可以做到收集約400幀畫面，即可估計出良好品質的背景。</p>
<h4 id="Object-Detection">Object Detection</h4>
<p>我們基於Foreground Detection的結果，使用了以下論文的方法進行輪廓節測後，標註出Bounding Box。</p>
<blockquote>
<p>Suzuki, S. and Abe, K., Topological Structural Analysis of Digitized Binary Images by Border Following. CVGIP 30 1, pp 32-46 (1985)</p>
</blockquote>
<h4 id="Object-Tracking">Object Tracking</h4>
<p>我們使用了以下論文的演算法，並重複利用Object Detection結果，優化Object Tracking的品質。</p>
<blockquote>
<p>Object Tracking Based on ORB and Temporal-Spacial Constraint by Shuang Wu,IEEE Student Member, Yawen Fan, Shibao Zheng, IEEE Member and Hua Yang, IEEE Member</p>
</blockquote>
<h4 id="Road-Marking-Detection">Road Marking Detection</h4>
<p>我們透過Foreground Detection的道模型估計的背景圖，接著過濾特定的Hue值後，使用Canny演算法進行邊緣檢測，最後在使用Hough Transform得到道路標線的回歸線。</p>
<h4 id="Training-Model">Training Model</h4>
<p>我們將Object Tracking的結果做Regression Analysis，得到每輛車子的回歸線。<br>
接著，將其使用Hierarchical Clustering進行分群，得到了每條道路的回歸線以及道路數量。<br>
最後，利用Road Marking Detection的結果，近一步的優化分群的結果。</p>
<h3 id="硬體加速">硬體加速</h3>
<h4 id="Eroding-and-Dilating">Eroding and Dilating</h4>
<p>在Foreground Detection與Road Marking Detection這兩個步驟時我們使用了此硬體加速，加速了預處理的效率。</p>
<h4 id="Canny演算法">Canny演算法</h4>
<p>在Road Marking Detection時，我們對此演算法此硬體加速。</p>
<h2 id="影片demo">影片demo</h2>
<ol>
<li>實際運行過程錄影</li>
<li>基本偵測demo</li>
<li>車道違規舉例</li>
</ol>
<h2 id="設計動機">設計動機</h2>
<p>目前台灣交通事故頻傳，時常能在新聞上看到因為不依規定行駛而產生的交通事故，造成了許多家庭的破碎，後續所帶來的社會勞動力減損等等問題，對於台灣社會來說是非常巨大的社會成本。<br>
在108年臺北市所出版的交通事故分析報告中指出，目前每年臺北市約有40600起交通事故，當中未注意車前狀況、未依規定讓車、變換車道或方向不當、左/右轉彎未依規定為產生事故原因的最大宗，約有24000件，佔所有事故約59%。從中，我們可以知道交通事故的產生與駕駛的違規行駛行為有緊密的關係。<br>
但針對這些交通違規情形，若僅依靠執法機關以人力現場取締，對於祭出相應的懲罰將會非常困難，若此時能引入人工智慧系統協助人員判定，可以讓違規的駕駛得到應有的懲罰，減少違規與意外的發生。<br>
但智慧交通雖以行之有年(1960-1970)，但一直以來覆蓋率一直不高。在台北市僅有1%的路口採用，受限於他的低精準度，高成本，且無法即時解析結果所影響。</p>
<p>因此，我們希望透過這次比賽，設計出低資源消耗的即時運算系統，透過FPGA硬體效能的優勢與PYNQ的方便設計，輕量我們的智慧系統，並且降低系統的建設成本。</p>
<h2 id="主要貢獻">主要貢獻</h2>
<p>為了解決交通違規的相關問題，我們基於PYNQZ2設計了一套系統，改良現有問題，實現下列所述的優點。</p>
<ol>
<li>實現及時監測
<ul>
<li>可以立即的監測車道違規狀況，並通知執法機關。</li>
<li>前方道路車禍預警，若發生車禍可以即時通知後方車輛改道，避免追撞與交通壅塞的產生。</li>
</ul>
</li>
<li>輕量化系統。
<ul>
<li>藉由縮小系統，提升運算速度。</li>
</ul>
</li>
<li>提升泛用性與便捷性。
<ul>
<li>因不須預先進行訓練，可以依據當地環境進行自動調適。</li>
</ul>
</li>
<li>節省成本。
<ul>
<li>我們已可現有監視器取得的畫面利用於進行辨識，無須重新架設新系統。</li>
<li>降低系統架設所需安裝成本，減少政府在安裝時系統所需支出，提高智慧監控系統在道路上的覆蓋率。</li>
</ul>
</li>
</ol>
<h2 id="設計方法">設計方法</h2>
<p>以下為我們的設計流程</p>
<pre class="mermaid">graph TD
frame(Frame)
KNN(Foreground Detection Based on KNN)
dt_cnt(Detect Contours)
frame --> KNN
KNN -- Foreground mask --> dt_cnt(Detect Contours)
dt_cnt -- Bounding box --> C2(ORB Object Tracking)
C2 -- Regression Analysis --> A3(Dataset)
C2 -- Trace --> A4(Draw Result)

KNN -- Background Image --> B1(Canny Edge Detection)
B1 --> B2(Hough transform)
B2 -- Regression Line of Road Marking --> D2(Post-processing)

A3 -- Dataset.size > threshold --> D1(Hierarchical Clustering)
D1(Hierarchical Clustering) --> D2
D2 -- Regression Line of Roads --> A4</pre>
<p>透過KNN收集前兩百幀影像資料，進行差異化去除，取得背景後，將新的圖片扣除背景，取得車輛。背景經由Canny算出道路，與車輛追蹤處理後的結果，可以取得車子的運行位置，是否偏移，也可以計算車通量與異常移動等。<br>
其中我們透過PYNQ平台所提供的xfopencv進行影像處理加速，整套系統無須預先進行模型標注訓練，只需在白天時安裝，系統將自動採集資源。</p>
<h4 id="車輛軌跡偵測">車輛軌跡偵測</h4>
<p>從每一幀圖片讀取出車輛後，我們利用圖片相似度、距離、大小等綜合分析後，進行車輛編號追蹤，並對其在每一幀中的座標，進行軌跡分析。</p>
<h4 id="車輛切換車道辨識">車輛切換車道辨識</h4>
<p>我們透過蒐集影像，去除差異化後，取得監視器視角的背景，並分析車道。綜合上述軌跡分析，可以辨識出車輛變換車道，乃至蛇行或壓線行駛。</p>
<h4 id="違規左右轉偵測">違規左右轉偵測</h4>
<p>當鏡頭在路口時，透過軌跡分析與車道辨識，即可抓出該車輛是否違規轉彎。</p>
<h4 id="車流量統計">車流量統計</h4>
<p>當螢幕中出現新的車輛，便進行統計，即可知道每分鐘進入監視器範圍內的車輛有多少，進行塞車等分析。</p>
<h2 id="實驗結果">實驗結果</h2>
<p>在性能上，相比傳統使用yolo運算(平台:PYNQ-Z2)，充分的展現了此演算法的速度提升。</p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">ours</th>
<th style="text-align:center">YOLO-Tiny(with hardware acceleration)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">速度</td>
<td style="text-align:center">480p@20fps</td>
<td style="text-align:center">480p@2fps</td>
</tr>
<tr>
<td style="text-align:center">RAM</td>
<td style="text-align:center">&lt;1Mb</td>
<td style="text-align:center">~127 Mb</td>
</tr>
<tr>
<td style="text-align:center">訓練資料</td>
<td style="text-align:center">約200幀，無須標註</td>
<td style="text-align:center">約$3*10^5$張標註資料</td>
</tr>
<tr>
<td style="text-align:center">訓練時間</td>
<td style="text-align:center">&lt;10s</td>
<td style="text-align:center">N/A</td>
</tr>
</tbody>
</table>
<p>功能上，我們目前提供了以下功能:</p>
<ul>
<li>車輛軌跡偵測</li>
<li>車輛切換車道辨識</li>
<li>違規左右轉偵測</li>
<li>車流量統計</li>
</ul>
<h3 id="優勢分析">優勢分析</h3>
<ol>
<li>FPS高，可以做到real-time</li>
<li>模型小，可以節省RAM的使用與計算資源</li>
<li>無須標註的訓練資料，節省成本(事實上，直接使用預訓練的Yolo模型，預測解果並不準確，仍需要針對使用場景提供標註好的訓練資料來對模型做微調，才能達到較為理想到效果)</li>
<li>訓練時間短，YOLO幾乎不可能在板子上完成訓練或是微調</li>
<li>追蹤準確，因為YOLO的FPS低，使得其用來追蹤的演算法(Deep Sort)的準確率也受到影響</li>
</ol>
<h2 id="結論">結論</h2>
<p>根據上述的演算法結果，我們可以達到我們一開始所希望改善的四項重要目標，在即時監測的部分，我們相比起YOLO提升了十倍的運算速度。容量上我們僅使用不到YOLO 1% 的空間消耗。成本上我們僅需使用PYNQ平台搭配現有監視器即可穩定運行，無須使用額外的硬體架設以及標註資料。這幾項特點讓我們所設計的演算法相對於其他現有的演算法更加的適合應用在智慧交通系統之上。</p>
<p>我們認為此演算法在智慧交通的領域方面可以提供更多相關的服務，如以下這幾點:</p>
<ul>
<li>車禍辨識</li>
<li>道路掉落物偵測</li>
<li>動物誤闖道路偵測</li>
<li>讓智慧交通的技術發展更加完善。</li>
</ul>
<p>我們這套演算法相較於傳統演算法有許多的優勢，可以應用在智慧交通監控上面，解決以往智慧交通系統覆蓋率不高的這項問題，讓交通管理單位在管理上能夠減少更多人力資源的支出，提供用路人優良的行車環境。</p>
<h2 id="成果展示">成果展示</h2>
<div class="video-container"><iframe src="https://www.youtube.com/embed/J0AwPJ_tVuo" frameborder="0" loading="lazy" allowfullscreen></iframe></div>

        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/tw/tm-robot-hackathon/" data-toggle="tooltip" data-placement="top" title="tm-robot-hackathon">&larr; Previous Post</a>
          </li>
          
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      如果您喜歡此篇貼文，歡迎聯絡我。 也歡迎分享給朋友，以便更多人可以參與。謝謝 ！
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->


<!-- 2. gitment comment -->


<!-- 3. disqus comment -->

  <!-- disqus comment start -->

  <div class="comment">
    <div id="disqus_thread" class="disqus-thread"></div>
  </div>

  <!-- disqus embedded js code start (one page only need to embed once) -->
  <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "kazumiline";
    var disqus_identifier = "https://kazumiline.github.io/tw/xilinx-pynq-hackathon/";
    var disqus_url = "https://kazumiline.github.io/tw/xilinx-pynq-hackathon/";

    (function () {
      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <!-- disqus embedded js code start end -->

  <!-- disqus comment end -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">目錄</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">FPGA Object Detection&amp;Tracking</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E7%B0%A1%E4%BB%8B"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">簡介</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Solution"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">Solution</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%BC%94%E7%AE%97%E6%B3%95"><span class="toc-nav-number">1.2.1.</span> <span class="toc-nav-text">演算法</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Foreground-Detection"><span class="toc-nav-number">1.2.1.1.</span> <span class="toc-nav-text">Foreground Detection</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Object-Detection"><span class="toc-nav-number">1.2.1.2.</span> <span class="toc-nav-text">Object Detection</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Object-Tracking"><span class="toc-nav-number">1.2.1.3.</span> <span class="toc-nav-text">Object Tracking</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Road-Marking-Detection"><span class="toc-nav-number">1.2.1.4.</span> <span class="toc-nav-text">Road Marking Detection</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Training-Model"><span class="toc-nav-number">1.2.1.5.</span> <span class="toc-nav-text">Training Model</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%A1%AC%E9%AB%94%E5%8A%A0%E9%80%9F"><span class="toc-nav-number">1.2.2.</span> <span class="toc-nav-text">硬體加速</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Eroding-and-Dilating"><span class="toc-nav-number">1.2.2.1.</span> <span class="toc-nav-text">Eroding and Dilating</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Canny%E6%BC%94%E7%AE%97%E6%B3%95"><span class="toc-nav-number">1.2.2.2.</span> <span class="toc-nav-text">Canny演算法</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%BD%B1%E7%89%87demo"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">影片demo</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E8%A8%AD%E8%A8%88%E5%8B%95%E6%A9%9F"><span class="toc-nav-number">1.4.</span> <span class="toc-nav-text">設計動機</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E4%B8%BB%E8%A6%81%E8%B2%A2%E7%8D%BB"><span class="toc-nav-number">1.5.</span> <span class="toc-nav-text">主要貢獻</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E8%A8%AD%E8%A8%88%E6%96%B9%E6%B3%95"><span class="toc-nav-number">1.6.</span> <span class="toc-nav-text">設計方法</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%BB%8A%E8%BC%9B%E8%BB%8C%E8%B7%A1%E5%81%B5%E6%B8%AC"><span class="toc-nav-number">1.6.0.1.</span> <span class="toc-nav-text">車輛軌跡偵測</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%BB%8A%E8%BC%9B%E5%88%87%E6%8F%9B%E8%BB%8A%E9%81%93%E8%BE%A8%E8%AD%98"><span class="toc-nav-number">1.6.0.2.</span> <span class="toc-nav-text">車輛切換車道辨識</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E9%81%95%E8%A6%8F%E5%B7%A6%E5%8F%B3%E8%BD%89%E5%81%B5%E6%B8%AC"><span class="toc-nav-number">1.6.0.3.</span> <span class="toc-nav-text">違規左右轉偵測</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%BB%8A%E6%B5%81%E9%87%8F%E7%B5%B1%E8%A8%88"><span class="toc-nav-number">1.6.0.4.</span> <span class="toc-nav-text">車流量統計</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%AF%A6%E9%A9%97%E7%B5%90%E6%9E%9C"><span class="toc-nav-number">1.7.</span> <span class="toc-nav-text">實驗結果</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%84%AA%E5%8B%A2%E5%88%86%E6%9E%90"><span class="toc-nav-number">1.7.1.</span> <span class="toc-nav-text">優勢分析</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E7%B5%90%E8%AB%96"><span class="toc-nav-number">1.8.</span> <span class="toc-nav-text">結論</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%88%90%E6%9E%9C%E5%B1%95%E7%A4%BA"><span class="toc-nav-number">1.9.</span> <span class="toc-nav-text">成果展示</span></a></li></ol></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">特色標簽</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#Hackathon" title="Hackathon">Hackathon</a>
            
            <a class="tag" href="/tags/#Python" title="Python">Python</a>
            
            <a class="tag" href="/tags/#OpenCV" title="OpenCV">OpenCV</a>
            
            <a class="tag" href="/tags/#FPGA" title="FPGA">FPGA</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>鏈友</h5>
        <ul class="list-inline">

          
          <li>
            <a href="https://github.com/minitotoro" target="_blank">Jay</a>
          </li>
          
          <li>
            <a href="https://github.com/paddy41601" target="_blank">paddy</a>
          </li>
          
          <li>
            <a href="https://github.com/ii64" target="_blank">ii64</a>
          </li>
          
          <li>
            <a href="http://www.yukion.net/" target="_blank">amemiya</a>
          </li>
          
          <li>
            <a href="https://github.com/FIREoo" target="_blank">Fire</a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          
            <li>
              <a target="_blank" href="https://github.com/KazumiLine">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          
            <li>
              <a target="_blank" href="https://www.instagram.com/amemiya9181">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          

          
          
          
          <li>
            <a target="_blank" href="https://line.me/ti/p/~30080830">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-phone fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          KazumiLin
          2022
          <br>
          Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script type="text/javascript" src="/js/jquery.min.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="/js/hux-blog.min.js"></script>
  <!-- catalog -->
  <script async="true" type="text/javascript" src="/js/catalog.js"></script>
  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="/js/totop.js"></script>

  
    <!-- Busuanzi JavaScript -->
    <script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="/js/scroll.js"></script>
    <!-- Scroll end -->
  

  
    <!-- LangSelect start -->
    <script type="text/javascript" src="/js/langselect.js"></script>
    <!-- LangSelect end -->
  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="/js/mouseclick.js" content='The first step is as good as half over...,Laugh and grow fat...,Man proposes God disposes...,When all else is lost the future still remains...,Wasting time is robbing oneself...,Sharp tools make good work...,Cease to struggle and you cease to live...,A friend in need is a friend indeed...,Faith can move mountains...' color='#9933CC,#339933,#66CCCC,#FF99CC,#CCCCFF,#6666CC,#663399,#66CC99,#FF0033'></script>
  

  
    <!-- ribbon -->
    <script type="text/javascript" src="/js/ribbonDynamic.js"></script>
  

  






  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("https://kazumiline.github.io/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="搜索..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	</body>
</html>
